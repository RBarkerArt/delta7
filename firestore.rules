rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCTIONS ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.role == 'admin' || 
        request.auth.token.email == 'robert.barker2008@gmail.com'
      );
    }

    function isVisitorOwner(visitorId) {
      // Check if the current auth user has a mapping to this visitorId
      return isAuthenticated() && 
        get(/databases/$(database)/documents/firebase_uid_mapping/$(request.auth.uid)).data.visitorId == visitorId;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- VALIDATION FUNCTIONS (Protocol 1.1) ---

    // Validate Observer Update
    function isValidObserverUpdate() {
       let data = request.resource.data;
       // Ensure mandatory fields have correct types if present
       return (
         (!('coherenceScore' in data) || data.coherenceScore is number) &&
         (!('dayProgress' in data) || data.dayProgress is int) &&
         (!('lastSeenAt' in data) || data.lastSeenAt is timestamp) &&
         (!('isAnchored' in data) || data.isAnchored is bool)
       );
    }
    
    // Validate User Update (Legacy/Auth)
    function isValidUserUpdate() {
        let data = request.resource.data;
        return (
            (!('email' in data) || data.email is string) &&
            (!('displayName' in data) || data.displayName is string)
        );
    }

    // --- RULES ---

    // Legacy users collection
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow write: if isAdmin() || (isOwner(userId) && isValidUserUpdate());
    }

    // New dual-identity observers collection
    match /observers/{visitorId} {
      allow read: if isAdmin() || isVisitorOwner(visitorId);
      // Allow write if admin OR (owner AND strictly validated)
      allow write: if isAdmin() || (isVisitorOwner(visitorId) && isValidObserverUpdate());
    }

    // Lookup table for mapping Firebase UID to Visitor ID
    match /firebase_uid_mapping/{firebaseUid} {
      allow read: if isAdmin() || isOwner(firebaseUid);
      // Only allow creation/update if user owns the mapping
      allow write: if isAdmin() || isOwner(firebaseUid); 
    }
    
    // Narrative content: Public read, Admin write
    match /season1_days/{dayId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /season1_prologues/{prologueId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Access codes: Backend-only access via Admin SDK
    // These are used for session recovery (Project Signal)
    match /access_codes/{codeId} {
      allow read, write: if false;  // Only Admin SDK can access
    }
    // System settings: Admin-only
    match /system/{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
